<div class="login-dialog-wrapper">
  <mat-card class="login-card">
    <mat-card-header>
      <div class="header-content">
        <br>
        <h2 class="login-title">Iniciar Sesión</h2>
        <img src="assets/logomsjl.jpg" alt="Logo" class="logo-img">
      </div>
    </mat-card-header>
    <h2 class="login-title">Ingrese sus credenciales</h2>

    <form class="form-group" [formGroup]="_formulario" (ngSubmit)="login()" #loginForm="ngForm">
      <mat-card-content>
        <!-- Campos de usuario y contraseña (primera fase) -->
        <div *ngIf="!showCodeInput()">
          <mat-form-field class="example-full-width" appearance="fill">
            <mat-label style="font-weight: bold;">USUARIO</mat-label>
            <mat-icon matPrefix>person</mat-icon>
            <input matInput type="text" name="username" formControlName="username"
               placeholder="Usuario Administrador"
              [(ngModel)]="username" class="username" maxlength="60" />
            <mat-error *ngIf="_formulario.get('username')?.hasError('required')">
              El usuario es requerido
            </mat-error>
          </mat-form-field>
          <mat-form-field class="example-full-width" appearance="fill">
            <mat-label style="font-weight: bold;">CONTRASEÑA</mat-label>
            <mat-icon matPrefix>lock</mat-icon>
            <input matInput type="password" formControlName="password" name="password"
              placeholder="Contraseña" [(ngModel)]="password" class="password"
              required minlength="8" maxlength="30" />
            <mat-error *ngIf="_formulario.get('password')?.hasError('required')">
              La contraseña es requerida
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Campo de código de acceso (segunda fase) -->
        <div *ngIf="showCodeInput()">
          <div class="access-code-display">
            <p>Código de acceso configurado automáticamente:</p>
            <h2>{{ getMaskedCode() }}</h2>
            <p class="access-code-hint">Últimos 4 dígitos visibles. Verifique y confirme.</p>
          </div>
          <mat-form-field class="example-full-width" appearance="fill">
            <mat-label style="font-weight: bold;">CÓDIGO DE ACCESO</mat-label>
            <mat-icon matPrefix>vpn_key</mat-icon>
            <input matInput
                   [type]="showPassword ? 'text' : 'password'"
                   formControlName="accessCode"
                   name="accessCode"
                   [placeholder]="getMaskedCode() || 'Código configurado automáticamente'"
                   [(ngModel)]="accessCode"
                   class="access-code" />
            <button mat-icon-button
                    matSuffix
                    (click)="showPassword = !showPassword"
                    type="button"
                    matTooltip="{{ showPassword ? 'Ocultar' : 'Mostrar' }} código">
              <mat-icon>{{ showPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-error *ngIf="_formulario.get('accessCode')?.hasError('required')">
              El código de acceso es requerido
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Mensajes de error -->
        <div *ngIf="error" class="error-message">
          <mat-icon>error</mat-icon>
          {{ error }}
        </div>

        <!-- Botones -->
        <button mat-raised-button type="submit" class="add" [disabled]="_formulario.invalid || loading()">
          <mat-spinner *ngIf="loading()" diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
          <span *ngIf="!loading()">
            {{ showCodeInput() ? 'Verificar Código' : 'Iniciar Sesión' }}
          </span>
          <mat-icon *ngIf="!loading()">{{ showCodeInput() ? 'check' : 'arrow_forward' }}</mat-icon>
        </button>

        <button *ngIf="showCodeInput()" mat-raised-button type="button" class="volver" (click)="resetForm()">
          Volver
          <mat-icon>arrow_back</mat-icon>
        </button>

        <button *ngIf="!showCodeInput()" mat-raised-button type="button" class="volver" (click)="closeDialog()">
          Cancelar
          <mat-icon>close</mat-icon>
        </button>
        <br>
      </mat-card-content>
    </form>
  </mat-card>
</div>
